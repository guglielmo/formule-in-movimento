# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Formule in Movimento** creates mathematical and physics animations using Manim (Community Edition), a Python library for creating educational animations. The project is designed to make complex concepts accessible to students through visual storytelling, optimized for mobile devices and social media sharing.

All content (animations, web pages, documentation) is in **Italian**.

## CRITICAL: Makefile-First Development

**When working with this project, you (Claude) MUST:**

1. **Always use Makefile commands** - Never suggest or use raw `manim` or `npm` commands
2. **Create animations with make** - Use `make new-animation` to create new animations
3. **Test with make** - Use `make <animation> QUALITY=ql` to test animations
4. **Deploy with make** - Use `make deploy-full` or related targets for deployment
5. **Suggest make commands** - When the user asks to do something, propose the make command first

**Examples of correct responses:**

- User: "Create a new animation about derivatives"
  - ✅ Claude: "I'll create the animation using: `make new-animation DISCIPLINE=matematica TOPIC=derivate`"
  - ❌ NOT: "I'll create the directory and files..."

- User: "Test the gas animation"
  - ✅ Claude: "I'll test it using: `make gas_perfetto QUALITY=ql`"
  - ❌ NOT: "I'll run `manim -pql gas_perfetto.py`"

- User: "Build the frontend"
  - ✅ Claude: "I'll build it using: `make frontend-build`"
  - ❌ NOT: "I'll run `cd frontend && npm run build`"

**The Makefile is the single source of truth for all operations.**

### Project Name Meaning

"Formule in Movimento" has two interconnected meanings:
1. **Dynamic animations** - Formulas, expressions, and experiments brought to life through motion and transformation in Manim videos. Every element moves, transforms, and animates to explain concepts - not static content
2. **Mobile content** - Videos designed to be consumed "on the go" (in movimento) on mobile devices and shared on social platforms

## Project Structure

```
formule-in-movimento/
├── frontend/                           # Astro frontend application
│   ├── src/
│   │   ├── pages/                     # Astro pages (routes)
│   │   │   ├── index.astro           # Homepage
│   │   │   ├── 404.astro             # Error page
│   │   │   ├── matematica/           # Mathematics section
│   │   │   │   ├── index.astro       # Math section landing
│   │   │   │   └── equazioni-lineari.astro  # Lesson page
│   │   │   └── fisica/               # Physics section
│   │   │       └── index.astro       # Physics section landing
│   │   ├── components/               # Reusable Vue/Astro components
│   │   ├── layouts/                  # Page layouts
│   │   └── styles/                   # CSS stylesheets
│   ├── public/                       # Static assets (favicon, etc.)
│   │   └── media -> ../../media      # Symlink to video files
│   ├── dist/                         # Build output (generated by npm run build)
│   └── package.json
├── animations/                        # Manim Python source files
│   ├── matematica/                    # Mathematics animations
│   │   └── [topic]/
│   │       └── [name].py             # Manim scene definitions
│   └── fisica/                        # Physics animations
│       └── [topic]/
│           └── [name].py
├── media/                             # Centralized video output directory
│   └── matematica/                    # Videos organized by discipline
│       └── [topic]/
│           └── videos/
│               └── [quality]/         # e.g., 854p15, 1920p60
│                   └── [Scene].mp4
├── nginx.conf                         # nginx config for direct deployment
├── docker-compose.yml                 # Docker Compose configuration
├── Dockerfile                         # Docker build for production
└── DEPLOYMENT.md                      # Deployment guide

Shared virtual environment: ~/.virtualenvs/manim (used across all Manim projects)
```

## Architecture Principles

**Animation Organization:**
- Animations are organized into two main disciplines: `matematica/` and `fisica/`
- Each concept lives in its own subdirectory under the respective discipline
- Each animation directory contains:
  - Python file(s) with Manim scene classes
  - `index.html` page showcasing the animations with Italian descriptions
  - `media/` directory with rendered videos (auto-generated by Manim)

**Styling Convention:**
- **Light background theme**: All animations use `self.camera.background_color = WHITE`
- **Dark colors for visibility**: Use `BLACK`, `DARK_BLUE`, `RED_D`, `GREEN_D`, `BLUE_D`, `DARK_GRAY`
- **Italian labels**: All text in animations and HTML pages must be in Italian
- **Web design**: Light, clean theme with professional styling for accessibility and mobile viewing

**Mobile-First Design:**
- **Responsive layouts**: HTML pages must be mobile-responsive
- **Vertical video support**: Consider 9:16 aspect ratio for social media (use `--resolution 1080,1920`)
- **Touch-friendly**: Buttons and interactive elements sized for touch screens
- **Fast loading**: Optimize video file sizes for mobile networks
- **Easy sharing**: Include embed codes and social sharing buttons

## Makefile: The Central Command Interface

**IMPORTANT: All operations MUST go through the Makefile.** Do not use Manim commands directly, do not use npm commands directly. The Makefile is the single source of truth for all project operations.

### Why Use the Makefile?

1. **Auto-discovery**: Animations are automatically detected - no manual configuration
2. **Consistency**: Same commands work for all animations (1, 10, or 1000)
3. **Quality management**: Clear separation between dev and prod builds
4. **Deployment**: Integrated deployment workflows
5. **Error prevention**: Built-in validation and checks

### Essential Commands

**Creating new animations:**
```bash
# ALWAYS use this to create new animations
make new-animation DISCIPLINE=matematica TOPIC=nuovo_argomento
make new-animation DISCIPLINE=fisica TOPIC=entropia

# This creates directory, template files, and config automatically
# The animation is immediately available (auto-discovered)
```

**Listing and inspecting:**
```bash
# List all available animations (auto-discovered)
make list

# List all scenes in a specific animation
make gas_perfetto LIST=true
make equazioni_lineari LIST=true
```

**Building animations (development):**
```bash
# Build single animation (low quality, fast)
make gas_perfetto QUALITY=ql
make equazioni_lineari QUALITY=ql

# Build specific scene only
make gas_perfetto CLASS=TrasformazioneIsoterma QUALITY=ql

# Build all animations for development
make build-dev
```

**Building animations (production):**
```bash
# Build single animation (high quality)
make gas_perfetto QUALITY=qh
make equazioni_lineari QUALITY=qh

# Build specific animation for production
make build-animation-prod ANIM=gas_perfetto

# Build all animations for production
make build-prod
```

**Frontend:**
```bash
# Development server with hot reload
make frontend-dev

# Build for production
make frontend-build
```

**Deployment:**
```bash
# Full deployment (frontend + animations)
make deploy-full

# Partial deployments
make deploy              # Frontend only
make deploy-animations   # Animations only
```

### DO NOT Use Direct Manim Commands

**❌ WRONG:**
```bash
cd animations/fisica/gas_perfetto
manim -pqh gas_perfetto.py TrasformazioneIsoterma --resolution 1080,1920
```

**✅ CORRECT:**
```bash
make gas_perfetto CLASS=TrasformazioneIsoterma QUALITY=qh
```

The Makefile handles:
- Correct resolution (1080x1920 vertical)
- Correct frame rate (15fps for ql, 60fps for qh)
- Correct media directory configuration
- Build tracking and timestamps

### Quality Flags
- `-ql`: Low quality (480p, 15fps) - fast preview
- `-qm`: Medium quality (720p, 30fps)
- `-qh`: High quality (1080p, 60fps) - **recommended for publication**
- `-qk`: 4K quality (2160p, 60fps)

### Other Useful Flags
- `-p`: Preview/play video after rendering
- `-s`: Save last frame as image only (no animation)
- `-a`: Render all scenes in the file
- `--resolution WIDTHxHEIGHT`: Custom resolution (e.g., `--resolution 1080,1920` for vertical video)

## Development Setup

### Environment
- Python 3.12 (specified in `.python-version`)
- Uses shared virtual environment in `~/.virtualenvs/manim/`

### Setup Commands
```bash
# Create shared virtual environment (one-time setup for all Manim projects)
python3 -m venv ~/.virtualenvs/manim

# Activate virtual environment
source ~/.virtualenvs/manim/bin/activate  # Linux/Mac
# or
%USERPROFILE%\.virtualenvs\manim\Scripts\activate  # Windows

# Install dependencies
pip install manim

# Or use the project Makefile
cd formule-in-movimento
make setup
```

**Note**: The virtual environment is shared across all Manim projects to save disk space (~500MB per project).

### Dependencies
- manim (Community Edition)
- LaTeX installation for mathematical typesetting (TeX Live on Linux, MiKTeX on Windows, MacTeX on macOS)

### Creating a New Animation

**ALWAYS use the Makefile to create new animations.** The workflow is:

1. **Create the animation using make:**
   ```bash
   # For mathematics
   make new-animation DISCIPLINE=matematica TOPIC=derivate

   # For physics
   make new-animation DISCIPLINE=fisica TOPIC=entropia
   ```

   This automatically creates:
   - Directory structure (`animations/[discipline]/[topic]/`)
   - Template Python file with Scene class and basic animation
   - Configured `manim.cfg` file
   - **Template Astro page** (`frontend/src/pages/[discipline]/[topic].astro`) with placeholders
   - The animation is immediately auto-discovered

2. **Verify it was created:**
   ```bash
   make list                    # Should show the new animation
   make derivate LIST=true      # List scenes (should show IntroScene)
   ```

3. **Edit the Python file:**
   - Open `animations/matematica/derivate/derivate.py`
   - Add your Manim scenes following the light theme conventions
   - Use Italian text in all labels and titles

4. **Test the animation:**
   ```bash
   # Quick test (low quality, fast render)
   make derivate QUALITY=ql

   # Test specific scene
   make derivate CLASS=IntroScene QUALITY=ql
   ```

5. **Edit the generated Astro page:**
   - Open `frontend/src/pages/matematica/derivate.astro` (already created!)
   - Replace placeholders with actual content in Italian
   - Add video sections for each scene
   - Add descriptions and explanations
   - Follow the pattern from `equazioni-lineari.astro` or `gas-perfetto.astro`

6. **Update the section index page:**
   - Edit `frontend/src/pages/matematica/index.astro`
   - Add a lesson card linking to the new animation

7. **Test and deploy:**
   ```bash
   # Test frontend locally
   make frontend-dev

   # Build for production
   make build-animation-prod ANIM=derivate
   make frontend-build

   # Deploy
   make deploy-full
   ```

**Never manually create directories or use raw Manim commands!** The Makefile ensures consistency.

## Frontend Development

The project uses **Astro** (with Vue components) for the frontend application.

### Frontend Structure

- **Pages** (`frontend/src/pages/`): File-based routing
  - `index.astro` → `/` (homepage)
  - `matematica/index.astro` → `/matematica` (section page)
  - `matematica/equazioni-lineari.astro` → `/matematica/equazioni-lineari` (lesson page)
  - `404.astro` → `/404` (error page)

- **Layouts** (`frontend/src/layouts/`): Reusable page templates
  - `BaseLayout.astro`: Base HTML structure with meta tags
  - `LessonLayout.astro`: Template for lesson pages with breadcrumbs

- **Components** (`frontend/src/components/`): Reusable UI elements
  - Can be Astro components (`.astro`) or Vue components (`.vue`)
  - Vue components require `client:load` directive in Astro pages

- **Styles** (`frontend/src/styles/`): CSS stylesheets
  - `common.css`: Shared styles for lesson pages
  - `home.css`: Homepage styles
  - `matematica-section.css`: Mathematics section styles
  - `fisica-section.css`: Physics section styles

### Frontend Commands

**Use Makefile commands instead of npm directly:**

```bash
# Install dependencies (only needed once)
make frontend-install

# Start development server (hot reload)
make frontend-dev
# → http://localhost:4321

# Build for production (outputs to dist/)
make frontend-build

# Preview production build locally
cd frontend && npm run preview  # (no make target for this, rarely used)
```

### Development Workflow

1. **Start dev server**: `make frontend-dev`
2. **Make changes** to `.astro` or `.vue` files
3. **View changes** at `http://localhost:4321` (auto-reloads)
4. **Build for production** when ready: `make frontend-build`
5. **Deploy**: `make deploy` or `make deploy-full`

### Adding New Pages

1. Create `.astro` file in `frontend/src/pages/`:
   ```astro
   ---
   import BaseLayout from '../layouts/BaseLayout.astro';
   ---
   <BaseLayout title="Page Title" description="Description">
     <h1>Content here</h1>
   </BaseLayout>
   ```

2. The file path determines the URL:
   - `pages/example.astro` → `/example`
   - `pages/example/index.astro` → `/example/`
   - `pages/example/nested.astro` → `/example/nested`

### Video Embedding

Videos are accessed via the `/media/` path thanks to the symlink:
```astro
<video controls>
  <source src="/media/matematica/equazioni_lineari/videos/854p15/SceneName.mp4" type="video/mp4">
</video>
```

### Styling Guidelines

- Use semantic HTML
- Mobile-first responsive design
- Light theme with high contrast colors
- Italian text throughout
- Follow existing patterns from `equazioni-lineari.astro`

## Animation Design Principles

When creating educational scenes for students:

- **Light theme required**: Always set `self.camera.background_color = WHITE` in `construct()`
- **Color palette**: Use dark colors (BLACK, DARK_BLUE, RED_D, GREEN_D, BLUE_D, DARK_GRAY) for high contrast
- **Italian language**: All text, labels (Text, MathTex) must be in Italian
- **Student-friendly**: Use clear, simple language; avoid overly academic terminology
- **Build intuition**: Focus on visual representation over formal proofs
- **Smooth transitions**: Use gradual transformations to show relationships
- **Short duration**: Keep animations concise (30-90 seconds ideal for social media)
- **Mobile viewing**: Ensure text is readable on small screens (larger font sizes)

### Mathematics Topics
Examples: algebra, geometry, trigonometry, functions, limits, derivatives, integrals, series

### Physics Topics
Primary focus: **thermodynamics** (current year's curriculum)
Other topics: general physics concepts as needed

## Technical Notes

- **Color application**: Use `.set_color()` method for axis labels rather than passing `color` parameter to `get_x_axis_label()` and `get_y_axis_label()` (Manim version compatibility)
- **Axis styling**: Set axis colors via `axis_config={"color": DARK_BLUE}` in Axes constructor
- **Video output**: Rendered videos go to centralized `media/<discipline>/<topic>/videos/<quality>/` directory (configured in Makefile with `--media_dir`)
- **Frontend access**: Videos are accessible in Astro via symlink `frontend/public/media -> ../../media`
- **Vertical video**: For social media, render with `--resolution 1080,1920` to create 9:16 aspect ratio
- **File naming**: Use descriptive, lowercase names with underscores (e.g., `moto_rettilineo_uniforme.py`)
- **Scene naming**: Use PascalCase for scene class names (e.g., `class MotoRettilineo(Scene):`)

## Content Strategy

### Mathematics Section (`animations/matematica/`)
Focus on:
- Visual proofs and demonstrations
- Geometric interpretations
- Function behavior and transformations
- Calculus concepts (limits, derivatives, integrals)
- Algebraic manipulations visualized

### Physics Section (`animations/fisica/`)
Primary focus on **thermodynamics**:
- Heat and temperature concepts
- Laws of thermodynamics (zeroth, first, second, third)
- Thermodynamic processes (isothermal, adiabatic, isobaric, isochoric)
- State variables and equations of state
- Heat engines and efficiency
- Entropy and disorder
- Real-world applications (engines, refrigerators, etc.)

Other physics topics as needed for general understanding

### Mobile & Social Optimization
- **Duration**: 30-90 seconds optimal for social media
- **Text size**: Larger fonts for mobile readability
- **Captions**: Consider adding Italian captions/subtitles
- **Hook**: Start with compelling visual in first 3 seconds
- **Format options**: Both horizontal (16:9) and vertical (9:16) versions when appropriate

## Development vs Production Workflow

The project has a clear separation between development and production environments:

### Development Environment

For fast iteration and local testing:

```bash
# Build animations (low quality, fast rendering)
make build-dev                         # All animations
make gas_perfetto QUALITY=ql           # Specific animation

# List scenes before building
make gas_perfetto LIST=true

# Start frontend dev server with hot reload
make frontend-dev
# Access at http://localhost:4321
```

**Development characteristics:**
- Low quality rendering (480x854, 15fps)
- Fast render times (~30 seconds per scene)
- Immediate feedback
- Local testing only

### Production Environment

For high-quality public deployment:

```bash
# Build animations (high quality for production)
make build-prod                        # All animations
make build-animation-prod ANIM=gas_perfetto  # Specific animation

# Build frontend
make frontend-build

# Deploy to production server
make deploy-full                       # Full site (frontend + animations)
make deploy                            # Frontend only
make deploy-animations                 # Animations only (rsync media/)
```

**Production characteristics:**
- High quality rendering (1080x1920, 60fps)
- Longer render times (~5-10 minutes per scene)
- Optimized for public consumption
- Deployed to production server

## Deployment Architecture

**CRITICAL: This project uses TWO different deployment modes:**

### 1. Local Testing (Standalone)

For quick local testing on `http://localhost:8080`:

```bash
# Use these commands for local testing ONLY
make deploy-podman-local    # Start local test server
make stop-podman-local      # Stop local test server
```

**Files used:**
- `docker-compose.local.yml` (in project directory)
- Exposes port 8080 directly
- Self-contained, no proxy needed
- **NOT for production use**

### 2. Production Deployment (via nginx-proxy)

For production deployment with SSL certificates and domain routing:

```bash
# Use this command for production deployment
make deploy-production      # Deploy to production via proxy
make status-production      # Check production status
make logs-production        # View production logs
```

**Architecture:**
```
Internet (80/443)
    ↓
nginx-proxy + acme-companion (at /home/gu/sites/proxy/)
    ↓
formule-in-movimento container (no exposed ports)
```

**Files used:**
- `/home/gu/sites/formule-in-movimento/docker-compose.yml` (production config)
- Connects to shared `proxy-network`
- No port exposure (proxy handles routing)
- Automatic SSL certificates via Let's Encrypt

**Directory structure:**
```
/home/gu/projects/formule-in-movimento/  # Source code
├── animations/              # Manim animations
├── frontend/                # Astro frontend
├── docker-compose.local.yml # Local testing only
└── Makefile                 # Build & deploy commands

/home/gu/sites/                          # Production deployment
├── proxy/                   # Shared proxy stack (starts first)
│   └── docker-compose.yml
└── formule-in-movimento/    # Site container config
    ├── docker-compose.yml   # Production config
    ├── Dockerfile
    └── .env                 # Domain & email
```

**Important:**
- `/home/gu/projects/` is for development and source code
- `/home/gu/sites/` is for production deployment configuration
- The proxy must be running before deploying sites
- `make deploy-production` automatically starts the proxy if needed

### Deploy to Production

The project uses a custom deployment script at `/home/gu/sites/deploy.sh` for the frontend and `rsync` for media files.

**Recommended: Full deployment**
```bash
# Builds everything and deploys to production
make deploy-full
```

This will:
1. Build all animations in high quality (`make build-prod`)
2. Build the frontend (`npm run build`)
3. Execute `/home/gu/sites/deploy.sh` to deploy the frontend
4. Rsync media files to `/home/gu/sites/formule-in-movimento/media/`

**Partial deployments:**
```bash
# Deploy only frontend (for code/HTML changes)
make deploy

# Deploy only animations (for new/updated videos)
make deploy-animations

# Build specific animation for production
make build-animation-prod ANIM=gas_perfetto
make deploy-animations
```

**Requirements:**
- `/home/gu/sites/deploy.sh` must exist
- `/home/gu/sites/formule-in-movimento/media/` directory must exist on the server
- `rsync` must be installed

### Local Testing with Docker Compose / Podman Compose

**IMPORTANT: For local testing only! Not for production.**

**With Podman (Recommended):**
```bash
# Build and start local test server
make deploy-podman-local

# Stop local test server
make stop-podman-local

# Restart after changes
make restart-podman-local

# Access at http://localhost:8080
```

**With Docker:**
```bash
# Build and start local test server
make deploy-docker-local

# Stop local test server
make stop-docker-local

# Restart after changes
make restart-docker-local

# Access at http://localhost:8080
```

**Legacy aliases (deprecated, show warnings):**
- `make deploy-podman` → redirects to `deploy-podman-local`
- `make deploy-docker` → redirects to `deploy-docker-local`

**For production deployment, use:**
```bash
make deploy-production
```

### Frontend Development Server

For rapid iteration during development:

```bash
# Start development server with hot reload
make frontend-dev
# Access at http://localhost:4321

# Build for production (without deploying)
make frontend-build
```

### Direct nginx Deployment

```bash
# Build the Astro site
cd frontend && npm run build

# Copy nginx config
sudo cp nginx.conf /etc/nginx/sites-available/formule-in-movimento

# Enable site
sudo ln -s /etc/nginx/sites-available/formule-in-movimento \
            /etc/nginx/sites-enabled/

# Test and reload
sudo nginx -t
sudo systemctl reload nginx
```

### Deployment Checklist

1. ✅ Create animation: `make new-animation DISCIPLINE=<discipline> TOPIC=<topic>`
2. ✅ Test animation: `make <topic> QUALITY=ql`
3. ✅ Create/update Astro pages in `frontend/src/pages/`
4. ✅ Test frontend locally: `make frontend-dev`
5. ✅ Build for production: `make build-animation-prod ANIM=<topic>` and `make frontend-build`
6. ✅ Deploy to production: `make deploy-full`

**Alternative: Quick frontend-only deploy:**
1. ✅ Edit Astro pages
2. ✅ Test: `make frontend-dev`
3. ✅ Deploy: `make deploy`

**Alternative: Quick animation-only deploy:**
1. ✅ Build animation: `make build-animation-prod ANIM=<topic>`
2. ✅ Deploy: `make deploy-animations`

For detailed deployment instructions, SSL setup, troubleshooting, and CI/CD integration, see **[DEPLOYMENT.md](DEPLOYMENT.md)**.
